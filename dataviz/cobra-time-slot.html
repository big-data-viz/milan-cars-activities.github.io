<!DOCTYPE html>
<html>
    <head>
        <title>Cobra</title>
        <link rel="stylesheet" type="text/css" href="library/style.css" />
        <script src="library/jquery.min.js" charset="utf-8"></script>
        <script src="library/d3.min.js" charset="utf-8"></script>
        <script src="library/index.js" charset="utf-8"></script>


        <link rel="stylesheet" type="text/css" href="library/d3.slider.css" media="screen" />
        <script src="library/d3.slider.js"></script>

        <meta charset="UTF-8">
    </head>
    <body class="background">
        <main>
           <!-- <p>Sec C</p>-->
           <!-- <svg ></svg> style="position:relative; left: 20px; top: 30px;" viewBox="0 0 60 55"-->
           	<!--<div id="option" style="margin: 30px 4%">
                <form>
                <div>
                    <input name="radio" id="radio1" type="radio" onclick="north()"><label for="radio1">North</label>
                    <input name="radio" id="radio2" type="radio" onclick="south()"><label for="radio2">South</label>
                    <input name="radio" id="radio3" type="radio" onclick="west()"><label for="radio3">West</label>
                    <input name="radio" id="radio4" type="radio" onclick="est()"><label for="radio4">Est</label>
                </div>
                </form>
            </div>-->
            
        </main>
        <!--<div id="slider"></div>-->
        <div class="clear">
        <script>

            //--------------------------------------------------
            // definisco le variabili
            //--------------------------------------------------

            var margin = {top: 10, right: 10, bottom: 10, left: 10} // 20
                width = 800 - margin.left - margin.right,
                height = 800 - margin.top - margin.bottom

            var color = {very_low:'#000000', low: '#2d2d2d', medium_low: '#565656', medium: '#0033ff', medium_high: '#33cccc', high: '#ff9999', very_high: '#ff0000'} //color schema F*/

            /*var color = {north : 'red', south: 'blue',  est: 'yellow', west: 'green'} */

            var tip = d3.tip()
                .attr('class', 'd3-tip')
                .offset([-10, 0])
                .html(function(d) { 
                    return 'Id: ' + d.id
                        + '<br/>Avg. speed: ' + (Math.ceil(d.avgspeed/1))   //  d.speed (restituisce tanti decimali); 
                        //+ '<br/>Direction: ' + d.direction
                        + '<br/>Cars: ' + (Math.ceil(d.cars/1))
                });    

            var svg = d3.select('main').append('svg')
                .attr('width', (width  + margin.left + margin.right))
                .attr('height', (height + margin.top + margin.bottom))
                .attr('viewBox','-740, -740, 800, 800')
                .attr('class','background map')

            // Initialize slider
            /*var slider = d3.slider().min(00).max(23).ticks(1).stepValues([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23]).tickValues([1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23]); //.showRange(true).value(6);*/
            // http://sujeetsr.github.io/d3.slider/
            // http://bl.ocks.org/carsonfarmer/11478345



            /*var x = d3.scale.linear()
                .domain([0, 180])
                .range([0, 200])
                .clamp(true);

            var brush = d3.svg.brush()
                .x(x)
                .extent([0, 0])
                .on("brush", brushed);*/

            /*var slider = svg.append("g")
                .attr("class", "slider")
                .call(brush);

            /*function brushed() {
                var value = brush.extent()[0];

                if (d3.event.sourceEvent) { // not a programmatic event
                    value = x.invert(d3.mouse(this)[0]);
                    brush.extent([value, value]);
                }

                handle.attr("cx", x(value));
                d3.select("body").style("background-color", d3.hsl(value, .8, .8));
            }

            function createSlider(){

                var val = slider ? slider.value() : 0;
                    slider = d3.slider()
                    .scale( sliderScale )
                    .on("slide",function(event,value){
                        if ( isPlaying ){
                        clearInterval(interval);
                        }
                        currentFrame = value;
                        drawMonth( orderedColumns[value], d3.event.type != "drag" );
                    })
                }
            */

            svg.call(tip)

            var map = svg.append('svg:image')
                .attr('xlink:href', 'library/images/milan-map.svg')
                /*.attr('xlink:href', function(d){
                    return 'library/images/' + d.key + '.svg';
                })*/
                .attr('x',-704)
                .attr('y',-704)
                .attr('width', 700)
                .attr('height',700)

            /*
            var box_legend = d3.select('main').append('svg')
                .attr('class','legend')
                .attr('viewBox','0, 0, 800, 70')
                //.attr('height',100)

            var legend = box_legend.append('svg:image')
                .attr('xlink:href', 'library/images/map-legend.svg') // map-legend.svg
                /*.attr('xlink:href', function(d){
                    return 'library/images/' + d.key + '.svg';
                })
                .attr('x', 50)
                .attr('y', 0)
                .attr('width', 710) //500
                .attr('height', 70) //100
            */

            d3.csv('data/time-slot/monday/0-mezzanotte.csv',loader);  //sec_a.csv

            //function loaded (data){
            function loader (data){
                
                // divido i dati per speed (operazione trascurabile)
                /*var speedrange = d3.nest()
                    .key (function(d){
                        var speed = d.speed;
                        if(d.speed >= 0 && d.speed < 45  ) {
                            return  0
                        }
                        if(d.speed >= 45 && d.speed < 65  ){
                            return  1
                        }
                        else {
                            return 2
                        }
                    })
                    .sortKeys(d3.ascending) //ordine crescente (corretto)
                    .entries(data);*/

                //--------------------------------------------------
                // inserisco gli elementi
                //--------------------------------------------------


                var box = svg.append('g')
                    //.attr('transform','translate(740,740)')
                    .attr('width', width)
                    .attr('height', height)
                    .attr ('class','box')

                // creo un gruppo per ogni singolo elemento in modo da applicargli come classe l'id
                var group = box.append('g')
                    .selectAll('g')
                    .data(data)
                    .enter()
                    .append('g')
                    .attr('class', function(d,i) {
                        return (d.id) // + ' ' + (d.direction) //(d.x) + ' ' + (d.y)
                    })
                    .on('mouseover', tip.show)
                    .on('mouseout', tip.hide)   

                var circles = group.append('circle')

                    /*.style("fill", function (d,i) {
                        if(d.avgspeed == 0) {
                            return  color.very_low // 'yellow'
                        }
                        if(d.avgspeed > 0 && d.avgspeed < 30  ) { //51
                            return  color.low
                        }
                        if(d.avgspeed >= 30 && d.avgspeed < 50  ){// 51  70
                            return  color.medium_low
                        }
                        if(d.avgspeed >= 50 && d.avgspeed < 70  ){  // 70 90
                            return  color.medium
                        }
                        if(d.avgspeed >= 70 && d.avgspeed < 90  ){
                            return  color.medium_high
                        }
                        if(d.avgspeed >= 70 && d.avgspeed < 100  ){
                            return  color.high
                        }
                        else {
                            return color.very_high
                        }
                    })*/
                    /*.style("fill", function (d,i) {
                        if(d.direction == 'NORTH') {
                            return  color.north
                        }
                        if(d.direction == 'SOUTH') {
                            return  color.south 
                        }
                        if(d.direction == 'EST') {
                            return  color.est 
                        }
                        else {
                            return color.west
                        }
                    })*/
                    .style('fill', 'red' )
                    .attr('transform', function(d,i){
                        // x =  ((id - intero(id/100))*100)-1)    y = intero(id / 100)   
                        return  'translate(' + ((((d.id)-((Math.ceil(d.id/100)))*100)-1)*7) + ',-' +  (Math.ceil(d.id/100)*7) + ')' //  (d.x)*7 + ',-' +   (d.y)*7 + ')' // --> (x,y)        
                    })
                    // i cerchi appaiono ingrandendosi 
                    .attr('r',0 )
                    .attr('class','dots')
                    .transition()
                        .delay(0)
                        .duration(100)
                        .ease('linear')
                        .attr('r', function (d,i) {
                            if (d.avgspeed > 100 ){

                                return (Math.sqrt(d.cars/3.14)) // / 1.7 
                            }
                            else {
                                return (Math.sqrt(d.cars/3.14)) / 2 // / 3.6  
                            }
                        })

                /*var c = svg.append("circle")
                    .attr("cx",10)
                    .attr("cy",10)
                    .attr("r", 10)
                    .attr("fill", "#111");*/

                var sw = true;

                /*
                d3.select("circle")
                    .transition()
                    .duration(2000)
                    .ease("exp-in-out")
                    .attr("r",100)
                    .each("end", pulsate(sw));

                
                function pulsate(sw){
                  if (sw){
                    d3.select("circle")
                      .transition()
                      .duration(2000)
                      .ease("exp-in-out")
                      .attr("r",100)
                      .each("end", function(){
                            sw = !sw
                            pulsate(sw)
                      });
                    } else {
                      d3.select("circle")
                      .transition()
                      .duration(2000)
                      .ease("exp-in-out")
                      .attr("r",10)
                      .each("end", function(){
                            sw = !sw
                            pulsate(sw)
                      });
                  };
                };
                */



                d3.select("dots")
                    .transition()
                    .duration(5000)
                    .ease("exp-in-out")
                    .attr("r",100)
                    .each("end", day_loop(sw));

                function day_loop(sw){
                    if (sw){

                        d3.selectAll('.box')
 
                        .transition()
                            .delay(0)
                            .duration(100)
                            .remove()

                        d3.selectAll('.hour')
                            .remove()

                        d3.csv("data/time-slot/monday/18-diciotto.csv", loader );  

                        var hour = svg.append('text')
                            .attr('class','hour')
                            .attr("x",10)
                            .attr("y", 10)
                            .text('18')
                            //.attr('font-size',12)
                            //.attr('fill','white')
                    }

                    else {
                          d3.select("circle")
                          .transition()
                          .duration(2000)
                          .ease("exp-in-out")
                          .attr("r",rMin)
                          .each("end", function(){
                                sw = !sw
                                pulsate(sw)
                          });
                      };
                    };


                }

                // Render the slider in the div
                /*var slide_value = d3.select('#slider').call(slider)
                    .on("slide", function (event, ui) {
                        if(ui.value > 1) {
                            d3.selectAll('.dots')
                                .style('fill','blue')
                        }
                        else {
                            d3.selectAll('.dots')
                                .style('fill','yellow')
                        }
                    })*/


                /*
                $("#slider").slider({
                    min: 0, // there are 71 months between 1/1/04 and 12/31/09, 0 is all events
                    max: 24,
                    value: 0, //default slider value
                    step: 1, // step is the allow increments the slider can move. 1 = one month
                    slide: function(event, ui) {
                        if(ev.originalEvent) { //ui.value
                            stopPlay();
                            update(ui.value, 0);
                            //d3.selectAll('.dots')
                            //    .style('fill','blue')
                        }
                    },
                    change: function(ev, ui) {
                        if(!ev.originalEvent) {
                            update(ui.value, 10);
                        }
                        /*else {
                            d3.selectAll('.dots')
                                .style('fill','yellow')
                        }
                    }*/
                //})


                //console.log(slide_value)

                /*
                var mouseover = d3.selectAll('dots')
                    .on('mouseover', function (d,i) {
                        return (Math.sqrt(d.cars/3.14))
                    }) 
                    .on('mouseout', function (d,i) {
                         return (Math.sqrt(d.cars/3.14)) / 1.7
                    })
                 */
                 
                };

            /*
            function north() {

                 d3.selectAll('.box')
 
                    .transition()
                        .delay(0)
                        .duration(100)
                        .remove()

                d3.csv("data/direction/nonmiNORTH.csv", loader );  //sec_a.csv

            }

            function south() {

                 d3.selectAll('.box')
                       
                    .transition()
                        .delay(0)
                        .duration(100)
                        .remove()

                d3.csv("data/direction/nonmiSOUTH.csv", loader );

            }

            function west() {

                 d3.selectAll('.box')
                      
                    .transition()
                        .delay(0)
                        .duration(100)
                        .remove()

                d3.csv("data/direction/nonmiWEST.csv", loader );

            }

            function est() {

                d3.selectAll('.box')

                    .transition()
                        .delay(0)
                        .duration(100)
                        .remove()

                d3.csv("data/direction/nonmiEST.csv", loader );

            }*/
            
        </script>
        <style>
            .background{
                background-color: #1c1c1c; /*#303030;*/
            }
            /*.map{
                background-image: url(library/milan-map.svg);
                background-size: 700px 700px;
                background-repeat: no-repeat;
                background-position: 99px 34px;
            }*/
            .d3-tip {
                line-height: 1;
                font-weight: bold;
                padding: 12px;
                background: rgba(0, 0, 0, 0.8);
                color: #fff;
                border-radius: 2px;
                font-size: 12px; /*13px*/
            }
            /* Creates a small triangle extender for the tooltip */
            .d3-tip:after {
                box-sizing: border-box;
                display: inline;
                width: 100%;
                line-height: 1;
                color: rgba(0, 0, 0, 0.8);
                content: "\25BC";
                position: absolute;
                text-align: center;
            }
            /* Style northward tooltips differently */
            .d3-tip.n:after {
                margin: -1px 0 0 0;
                top: 100%;
                left: 0;
            }
            input[type="radio"] {
                display: none;
            }
            label {
                background-color: rgb(63, 62, 62);
                width: 20%;
                padding: 4px;
                /*font-size: 13px;*/
                text-align: center;
                display: block;
                float: left;
                margin: 10px;
                box-shadow: 0px 2px 2px black; 
                color: white;
            }
            label:hover {
                background-color: rgb(93, 92, 92);
                box-shadow: 0px 1px 2px black; 
            }
            input[type="radio"]:checked + label {
               color: rgb(73, 72, 72);
               background-color: white;
               box-shadow: 0px 0px 2px black; 
            }
            .legend{
                position: relative;
                top: -50px;
            }
    </style>
    </body>
</html>